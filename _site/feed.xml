<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>大佛</title>
    <description>张一鸣|大佛</description>
    <link>http://dafoyiming.cn/</link>
    <atom:link href="http://dafoyiming.cn/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Wed, 13 Jan 2016 03:15:20 +0000</pubDate>
    <lastBuildDate>Wed, 13 Jan 2016 03:15:20 +0000</lastBuildDate>
    <generator>Jekyll v2.4.0</generator>
    
      <item>
        <title>How To Create Ds Vm</title>
        <description>&lt;h1 id=&quot;ds&quot;&gt;如何创建DS系列虚拟机&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;本文说明如何使用Azure PowerShell和 Azure Cli 创建DS系列虚拟机。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;powershellds&quot;&gt;使用powershell创建DS系列虚拟机&lt;/h2&gt;

&lt;h3 id=&quot;section&quot;&gt;创建高级存储账户&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;`New-AzureStorageAccount -StorageAccountName &quot;yourpremiumaccount&quot; -Location &quot;China East&quot; -Type &quot;Premium_LRS&quot;`
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;创建高级存储帐户时，必须将 Type 参数指定为 Premium_LRS&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;目前为止，尽在中国东部支持高级存储账号&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;section-1&quot;&gt;指定订阅及高级存储账户&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;`Set-AzureSubscription -SubscriptionName &quot;your subscription&quot;  -CurrentStorageAccountName &quot;yourpremiumaccount&quot;`
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;ds-1&quot;&gt;创建DS系列虚拟机&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt; $storageAccount = &quot;yourpremiumaccount&quot;
 $adminName = &quot;youradmin&quot;
 $adminPassword = &quot;yourpassword&quot;
 $vmName =&quot;yourVM&quot;
 $location = &quot;China East&quot;
 $imageName = &quot; 55bc2b193643443bb879a78bda516fc8__Windows-Server-2012-Datacenter-201504.01-zh.cn-127GB.vhd &quot;
 $vmSize =&quot;Standard_DS2&quot;
 $OSDiskPath = &quot;https://&quot; + $storageAccount + &quot;.blob.core.chinacloudapi.cn/vhds/&quot; + $vmName + &quot;_OS_PIO.vhd&quot;
 $vm = New-AzureVMConfig -Name $vmName -ImageName $imageName -InstanceSize $vmSize -MediaLocation $OSDiskPath   
 Add-AzureProvisioningConfig -Windows -VM $vm -AdminUsername $adminName -Password $adminPassword 
 New-AzureVM -ServiceName $vmName -VMs $VM -Location $location
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;如何获取当前可用的ImageName（由于Azure会定期更新ImageName，为了保证您能够填写正确的ImageName）可以通过下面的脚本查询一下。比如：&lt;/p&gt;

  &lt;pre&gt;&lt;code&gt;#操作系统类型OpenLogic 6.5，Windows Server 2012 R2 Datacenter (zh-cn)等
$osfamliy=&quot;Windows Server 2012 R2 Datacenter (zh-cn)&quot;  
Get-AzureVMImage | Where-Object {
$_.category -eq &quot;Public&quot; -and 
($_.ImageFamily -eq $osfamliy -or $_.Label -eq $osfamliy )}| Sort-Object publisheddate -Descending|
select imagename,os,label,publisheddate -First 1|
Format-Table -AutoSize   ![](http://i.imgur.com/wNP3fCt.png) ### 为虚拟机附加磁盘 ###
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code&gt;$storageAccount = &quot;yourpremiumaccount&quot;
$vmName =&quot;yourVM&quot;
$vm = Get-AzureVM -ServiceName $vmName -Name $vmName
$LunNo = 1	
$path = &quot;http://&quot; + $storageAccount + &quot;.blob.core.chinacloudapi.cn/vhds/&quot; + &quot;myDataDisk_&quot; + $LunNo + &quot;_PIO.vhd&quot;
$label = &quot;Disk &quot; + $LunNo
Add-AzureDataDisk -CreateNew -MediaLocation $path -DiskSizeInGB 128 -DiskLabel $label -LUN 
$LunNo -HostCaching ReadOnly -VM $vm | Update-AzureVm
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;azure-cli-ds&quot;&gt;使用Azure Cli 创建DS系列虚拟机&lt;/h2&gt;

&lt;h3 id=&quot;section-2&quot;&gt;创建高级存储账号&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;azure storage account create &quot;premiumtestaccount&quot; -l &quot;china east&quot; --type PLRS
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;ds-2&quot;&gt;创建DS系列虚拟机　&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;azure vm create -z &quot;Standard_DS2&quot; -l &quot;china east&quot; -e 22 
&quot;premium-test-vm&quot; &quot;f1179221e23b4dbb89e39d70e5bc9e72__OpenLogic-CentOS-70-20150325&quot; 
--userName &quot;youradminname&quot; 
-p &quot;Passwd@123&quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;CentOS 7.0 为例&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;section-3&quot;&gt;挂载数据磁盘&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;azure vm disk attach-new premium-test-vm 128 &quot;https://premiumtestaccount.blob.core.chinacloudapi.cn/vhds/myDataDisk_1_PIO.vhd&quot;
&lt;/code&gt;&lt;/pre&gt;
</description>
        <pubDate>Wed, 13 Jan 2016 00:00:00 +0000</pubDate>
        <link>http://dafoyiming.cn/2016/01/13/how-to-create-DS-VM/</link>
        <guid isPermaLink="true">http://dafoyiming.cn/2016/01/13/how-to-create-DS-VM/</guid>
        
        
      </item>
    
      <item>
        <title>How To Reserve Pip For Azure Vm By Cli</title>
        <description>&lt;h1 id=&quot;azure-cli-pip&quot;&gt;如何通过Azure Cli 创建PIP&lt;/h1&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;azure-publishsettingsfile&quot;&gt;下载Azure PublishsettingsFile&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;`C:\Users\zhang.yiming&amp;gt;azure account download -e AzureChinaCloud`
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/ai18X7X.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;请记录文件下载后的保存路径，导入时会用到
## 导入Azure PublishsettingsFile ##&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code&gt;`C:\Users\zhang.yiming&amp;gt;azure account import c:/Internal-004-Internal-002-WATSTest03
 -Internal-003-Internal-005-Internal-001-12-27-2015-credentials.publishsettings`
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;section&quot;&gt;设置默认管理订阅&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;列出目前可用的订阅&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;C:\Users\zhang.yiming&amp;gt;azure account list&lt;/code&gt;
  &lt;img src=&quot;http://i.imgur.com/0UkkjXJ.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;将需要设置PIP的虚拟机的订阅设置为默认订阅&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;C:\Users\zhang.yiming&amp;gt;azure account set 4c1f7e7c-****-****-****-****b58636&lt;/code&gt;
	 &lt;img src=&quot;http://i.imgur.com/I8zF17J.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;安全原因部分信息被隐去，请按照实际情况填写&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;查看虚拟机是否设置过PIP&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;C:\Users\zhang.yiming&amp;gt;azure vm public-ip list zymub&lt;/code&gt;&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/LxObm1m.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;为虚拟机设置PIP&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;C:\Users\zhang.yiming&amp;gt;azure vm public-ip set zymub zymubpip&lt;/code&gt;&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/mht9iWK.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;可以在检查一下当前的PIP&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;C:\Users\zhang.yiming&amp;gt;azure vm public-ip list zymub&lt;/code&gt;&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/TBxOHCy.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;C:\Users\zhang.yiming&amp;gt;azure vm show zymub&lt;/code&gt;&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/AP62cEh.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Sun, 10 Jan 2016 00:00:00 +0000</pubDate>
        <link>http://dafoyiming.cn/2016/01/10/how-to-reserve-PIP-for-Azure-VM-by-Cli/</link>
        <guid isPermaLink="true">http://dafoyiming.cn/2016/01/10/how-to-reserve-PIP-for-Azure-VM-by-Cli/</guid>
        
        
      </item>
    
      <item>
        <title>How To Config And Check Azure Ilb</title>
        <description>&lt;h1 id=&quot;azure-ilb&quot;&gt;如何创建Azure ILB并实现多端口负载及验证&lt;/h1&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section&quot;&gt;系统原理图&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;对Azure官方提供的原理图略作标注
&lt;img src=&quot;http://i.imgur.com/OQRFpxE.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ilb&quot;&gt;设置ILB&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;$svc=&quot;zymilb&quot;
$ilb=&quot;zym&quot;
$subnet=&quot;subnet01&quot;
$IP=&quot;10.0.0.10&quot;
Add-AzureInternalLoadBalancer -ServiceName $svc -InternalLoadBalancerName $ilb –SubnetName $subnet –StaticVNetIPAddress $IP
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;ilb-1&quot;&gt;添加虚机到ILB&lt;/h2&gt;

&lt;h3 id=&quot;udp&quot;&gt;添加UDP端口&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;$svc=&quot;zymilb&quot;
$vmname=&quot;zym01&quot;
$epname=&quot;InternalUDP&quot;
$lbsetname=&quot;UDP&quot;
$prot=&quot;udp&quot;
$locport=53
$pubport=53
$ilb=&quot;zym&quot;
Get-AzureVM –ServiceName $svc –Name $vmname | Add-AzureEndpoint -Name $epname -LbsetName $lbsetname -Protocol $prot
-LocalPort $locport -PublicPort $pubport –DefaultProbe -InternalLoadBalancerName $ilb | Update-AzureVM
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;tcp&quot;&gt;添加TCP端口&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;$svc=&quot;zymilb&quot;
$vmname=&quot;zym01&quot;
$epname=&quot;InternalTCP&quot;
$lbsetname=&quot;TCP&quot;
$prot=&quot;tcp&quot;
$locport=80
$pubport=80
$ilb=&quot;zym&quot;
Get-AzureVM –ServiceName $svc –Name $vmname | Add-AzureEndpoint -Name $epname -LbsetName $lbsetname -Protocol $prot
-LocalPort $locport -PublicPort $pubport –DefaultProbe -InternalLoadBalancerName $ilb | Update-AzureVM`
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;zym02、zym03 只需修改$vmname变量即可&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;section-1&quot;&gt;验证端口&lt;/h2&gt;

&lt;h3 id=&quot;udp53&quot;&gt;测试 UDP端口（53）&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;分别在zym01，zym02，zym03上抓包&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;[azureuser@zym01 ~]$ sudo tcpdump -i any -vnn udp port 53&lt;/code&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在zymclient上多次向ILB VIP 扫描53端口&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;[azureuser@zymclient ~]$ nc -vuz 10.0.0.10 53&lt;/code&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在zym01上发现这样的UDP包&lt;/p&gt;

    &lt;table&gt;
      &lt;tbody&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;12：35:47.543602&lt;/strong&gt; IP (tos 0x0, ttl 64, id 2501, offset 0, flags [DF], proto UDP (17), length 29) &lt;strong&gt;10.0.0.9.41723&lt;/strong&gt; &amp;gt; 10.0.0.6.53: [&lt;/td&gt;
          &lt;td&gt;domain]&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在zym02上发现这样的UDP包&lt;/p&gt;

    &lt;table&gt;
      &lt;tbody&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;12:37:28.548466&lt;/strong&gt; IP (tos 0x0, ttl 64, id 37980, offset 0, flags [DF], proto UDP (17), length 29) **10.0.0.9.37642 **&amp;gt; 10.0.0.7.53: [&lt;/td&gt;
          &lt;td&gt;domain]&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在zym03上发现这样的UDP包&lt;/p&gt;

    &lt;table&gt;
      &lt;tbody&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;12:36:44.057337&lt;/strong&gt; IP (tos 0x0, ttl 64, id 58980, offset 0, flags [DF], proto UDP (17), length 29) &lt;strong&gt;10.0.0.9&lt;/strong&gt;.59616 &amp;gt; 10.0.0.8.53: [&lt;/td&gt;
          &lt;td&gt;domain]&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;说明在这个时间段内三台机器分别收到了来自zymclient并由ILB转发过来的53端口请求&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;tcp80&quot;&gt;测试TCP端口（80）&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;分别在zym01，zym02，zym03上抓包&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;[azureuser@zym01 ~]$ sudo tcpdump -i any -vnn tcp port 80&lt;/code&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在zymclient上多次请求80端口服务&lt;/p&gt;

    &lt;p&gt;&lt;code&gt;[azureuser@zymclient ~]$ curl 10.0.0.6:80&lt;/code&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在zym01上发现这样的TCP包&lt;/p&gt;

    &lt;p&gt;&lt;strong&gt;13：09:20&lt;/strong&gt;.088717 IP (tos 0x0, ttl 64, id 7110, offset 0, flags [DF], proto TCP (6), length 2864) &lt;strong&gt;10.0.0.6.80 **&amp;gt; **10.0.0.9&lt;/strong&gt;.56679: Flags [.],&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在zym02上发现这样的TCP包&lt;/p&gt;

    &lt;p&gt;&lt;strong&gt;13:09:35&lt;/strong&gt;.086617 IP (tos 0x0, ttl 64, id 7110, offset 0, flags [DF], proto TCP (6), length 2864) &lt;strong&gt;10.0.0.6.80 **&amp;gt; **10.0.0.9&lt;/strong&gt;.58823: Flags [.]&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在zym03上发现这样的UDP包&lt;/p&gt;

    &lt;p&gt;&lt;strong&gt;13:09:56&lt;/strong&gt;.082415 IP (tos 0x0, ttl 64, id 7110, offset 0, flags [DF], proto TCP (6), length 2864) &lt;strong&gt;10.0.0.6.80 **&amp;gt; **10.0.0.9&lt;/strong&gt;.56548: Flags [.]&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;说明在这个时间段内三台机器分别收到了来自zymclient并由ILB转发过来的80端口的请求&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;centoshttp&quot;&gt;如何在Centos系统上安装Http服务&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;安装Httpd包&lt;/p&gt;

    &lt;p&gt;sudo yum install -y httpd&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;启动Http服务&lt;/p&gt;

    &lt;p&gt;sudo service httpd restart&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-2&quot;&gt;一个重要的问题&lt;/h2&gt;

&lt;p&gt;当客户自己添加一个自定义的UDP端口的时候，发现ILB并没有做任何转发！！&lt;/p&gt;

&lt;h3 id=&quot;section-3&quot;&gt;原因&lt;/h3&gt;

&lt;p&gt;ILB和SLB的原理其实是一样的都是通过Probe Protocol去侦测端口是不是up。目前azure支持的Probe protocol 有两种“tcp”，“http”。因此，基于UDP的端口（以9009为例）无法被ILB监测到，所以被认为端口是Down的，因此就不转发了&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/HG8Oipa.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;udp-53-&quot;&gt;关于 UDP 53 端口&lt;/h3&gt;

&lt;p&gt;此时，你肯定要问那为什么53 端口可以！！ 我们来看看53端口在服务器上的状态你就明白了&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/SlevF3f.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;原来如此，在azure上53端口同时开了两种协议TCP和UDP。ILB能够通过TCP监测到53端口是up的。所以53端口可以访问，因此ILB认为会转发请求&lt;/p&gt;

&lt;h3 id=&quot;section-4&quot;&gt;解决方案&lt;/h3&gt;

&lt;p&gt;针对UDP端口不做Probe监测。在创建添加endpoint的时候我们可以指定-Noprobe，这样问题就解决了&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Get-AzureVM –ServiceName $svc –Name $vmname | Add-AzureEndpoint -Name $epname -LbsetName $lbsetname -Protocol $prot
-LocalPort $locport -PublicPort $pubport –NoProbe -InternalLoadBalancerName $ilb | Update-AzureVM`
&lt;/code&gt;&lt;/pre&gt;
</description>
        <pubDate>Sun, 03 Jan 2016 00:00:00 +0000</pubDate>
        <link>http://dafoyiming.cn/2016/01/03/how-to-config-and-check-Azure-ILB/</link>
        <guid isPermaLink="true">http://dafoyiming.cn/2016/01/03/how-to-config-and-check-Azure-ILB/</guid>
        
        
      </item>
    
      <item>
        <title>How To Snapshot Azure Vm</title>
        <description>&lt;h1 id=&quot;azure-&quot;&gt;Azure 虚拟机镜像管理脚本说明&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;http://blogs.technet.com/b/canitpro/archive/2014/12/11/step-by-step-create-a-vm-snapshot-in-azure.aspx&quot; title=&quot;step-by-step-create-a-vm-snapshot-in-azure&quot;&gt;http://blogs.technet.com/b/canitpro/archive/2014/12/11/step-by-step-create-a-vm-snapshot-in-azure.aspx&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section&quot;&gt;准备工作&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;了解文件结构
&lt;img src=&quot;http://i.imgur.com/i2hJeiW.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
  &lt;li&gt;导入PublishSetting File
     Get-AzurePublishSettingsFile
     Import-AzurePublishSettingsFile&lt;/li&gt;
  &lt;li&gt;填写csv文件获取指纹信息
&lt;img src=&quot;http://i.imgur.com/UzUm7Sz.png&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://i.imgur.com/sRgEkey.png&quot; alt=&quot;&quot; /&gt;
## 主要问题 ##&lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
  &lt;li&gt;脚本编写于2013年，因此对Powershell的版本有一定的要求，需要使用较早版本的Powershell（推荐使用Powershell 0.8.12）&lt;/li&gt;
  &lt;li&gt;脚本针对Global Azure 设计，有些代码需要针对China Azure进行修改&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-1&quot;&gt;修改点&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;修改Azure Import-Module 为&lt;/p&gt;

    &lt;p&gt;Import-Module ‘C:\Program Files (x86)\Microsoft SDKs\Azure\PowerShell\ServiceManagement\Azure\Azure.psd1’&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;     - SnapshotVirtualMachine.ps1    51行
     - RestoreVirtualMachine.ps1     48行
     - GetSnapshotList.ps1           43行
     - DeleteOldSnapshots.ps1        37行
     - Commom/RepositoryCommon.ps1   13行
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;修改Common/RepositoryCommon&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
  &lt;li&gt;116行&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;添加-Environment AzureChinaCloud&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Set-AzureSubscription -Environment AzureChinaCloud -Certificate $managementCertificate -SubscriptionId $subscriptionId -CurrentStorageAccount $storageAccount -SubscriptionName $subscriptionName -SubscriptionDataFile $subscriptionDataFile
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;120行&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;添加-Environment AzureChinaCloud&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Set-AzureSubscription -Environment AzureChinaCloud -Certificate $managementCertificate -SubscriptionId $subscriptionId -CurrentStorageAccount $storageAccount -SubscriptionName $subscriptionName -SubscriptionDataFile $subscriptionDataFile
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;258行&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;添加EndpointSuffix=core.chinacloudapi.cn;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$connectionString = &quot;DefaultEndpointsProtocol=$($protocol);AccountName=$($storageAccountName);AccountKey=$($primaryKey);EndpointSuffix=core.chinacloudapi.cn;&quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;291行&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;原代码 .core.windows.net&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$matchList = [System.Text.RegularExpressions.Regex]::Match($blobUri, &quot;^(?&amp;lt;Protocol&amp;gt;http[s]?)://(?&amp;lt;StorageAccountName&amp;gt;[^/]*)\.blob\.core\.windows\.net/(?&amp;lt;ContainerName&amp;gt;[^/]*)/(?&amp;lt;BlobName&amp;gt;.*)$&quot;, $regexOptionFlags)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;新代码 .core.chinacloudapi.cn&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$matchList = [System.Text.RegularExpressions.Regex]::Match($blobUri, &quot;^(?&amp;lt;Protocol&amp;gt;http[s]?)://(?&amp;lt;StorageAccountName&amp;gt;[^/]*)\.blob\.core\.chinacloudapi\.cn/(?&amp;lt;ContainerName&amp;gt;[^/]*)/(?&amp;lt;BlobName&amp;gt;.*)$&quot;, $regexOptionFlags)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;section-2&quot;&gt;脚本执行&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;创建虚拟机镜像&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; PS C:\Scripts&amp;gt; .\SnapshotVirtualMachine.ps1 -subscriptionName Internal-002 -cloudServiceName zymub -virtualMachineName zymub -shutdownMachine -snapshotOsDisk  -snapshotDataDisks
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/1IsxOO9.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;列出虚拟机已有的镜像&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; PS C:\Scripts&amp;gt; .\GetSnapshotList.ps1 -subscriptionName Internal-002 -cloudServiceName zymub -virtualMachineName zymub -maximumDays 15
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/6o3BQx1.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;清除虚拟机镜像&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; PS C:\Scripts&amp;gt; .\DeleteOldSnapshots.ps1 -subscriptionName Internal-002 -cloudServiceName zymub -virtualMachineName zymub -maximumDays 1
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/U7PtugE.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;还原虚拟机&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; PS C:\Scripts&amp;gt; .\RestoreVirtualMachine.ps1 -subscriptionName Internal-002 -cloudServiceName zymub -virtualMachineName zymub -utcRestoreDate &quot;2015-DEC-26 10:05:43&quot;
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/BJPtCSC.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;hr /&gt;
&lt;p&gt;EOF2&lt;/p&gt;

</description>
        <pubDate>Wed, 30 Dec 2015 00:00:00 +0000</pubDate>
        <link>http://dafoyiming.cn/2015/12/30/how-to-snapshot-Azure-VM/</link>
        <guid isPermaLink="true">http://dafoyiming.cn/2015/12/30/how-to-snapshot-Azure-VM/</guid>
        
        
      </item>
    
  </channel>
</rss>
